title: ã€ŠObjective-C é«˜çº§ç¼–ç¨‹ã€‹è¯»ä¹¦ç¬”è®°
date: 2017/5/13 10:07:12  
categories: iOS
tags:
	- å­¦ä¹ ç¬”è®°
---

å¯¹è¿™æœ¬ä¹¦åšä¸€ä¸‹è¯»ä¹¦ç¬”è®°

<!--more-->

# è‡ªåŠ¨å¼•ç”¨è®¡æ•°

## å†…å­˜ç®¡ç†/å¼•ç”¨è®¡æ•°

### å†…å­˜ç®¡ç†çš„æ€è€ƒæ–¹å¼

**å¼•ç”¨è®¡æ•°çš„æ€è€ƒæ–¹å¼**ï¼š

- è‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±æŒæœ‰
- éè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±ä¹Ÿèƒ½æŒæœ‰
- ä¸å†éœ€è¦è‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶é‡Šæ”¾
- éè‡ªå·±æŒæœ‰çš„å¯¹è±¡æ— æ³•é‡Šæ”¾

**å¯¹è±¡æ“ä½œä¸OC æ–¹æ³•çš„å¯¹åº”:**

1. ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡ï¼š`alloc/new/copy/mutableCopy`
2. æŒæœ‰å¯¹è±¡ï¼š`retain`
3. é‡Šæ”¾å¯¹è±¡ï¼š`release`
4. åºŸå¼ƒå¯¹è±¡ï¼š`dealloc`

`NSObject` ç±»è´Ÿæ‹…å†…å­˜ç®¡ç†çš„èŒè´£ã€‚

#### è‡ªå·±ç”Ÿæˆå¯¹è±¡ï¼Œè‡ªå·±æŒæœ‰

ä½¿ç”¨ä»¥ä¸‹åç§°å¼€å¤´çš„æ–¹æ³•æ„å‘³ç€è‡ªå·±ç”Ÿæˆçš„å¯¹è±¡åªæœ‰è‡ªå·±æŒæœ‰ï¼š

- alloc
- new
- copy
- mutableCopy

> è¿™é‡Œçš„æ„æ€æ˜¯åªè¦**ä»¥è¿™å‡ ä¸ªè¯å¼€å¤´**ï¼Œå°±ä¸éœ€è¦å†è°ƒç”¨ `retain` æ–¹æ³•å°±å¯ä»¥ä¿ç•™äº†å¯¹è±¡äº†ã€‚åœ¨ ARC ä¸­ï¼Œç³»ç»Ÿä¸ä¼šè‡ªåŠ¨è¡¥ä¸Š retain æ–¹æ³•

```objc
// è‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡
id obj = [[NSObject alloc] init];
// è‡ªå·±æŒæœ‰å¯¹è±¡
```

è¿™é‡Œå°±ä¸ä¼šå†è°ƒç”¨ `[obj retain]` äº†ã€‚`obj` å·²ç»æŒæœ‰äº†å¯¹è±¡ã€‚

#### éè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±ä¹Ÿèƒ½æŒæœ‰

é™¤äº†ä¸Šé¢çš„æ–¹æ³•å–å¾—çš„å¯¹è±¡ï¼Œå› ä¸ºéè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰ï¼Œæ‰€ä»¥è‡ªå·±ä¸æ˜¯è¯¥å¯¹è±¡çš„æŒæœ‰è€…ã€‚

```objc
// å–å¾—éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡
id obj = [NSMutableArray array];
// å–å¾—å¯¹è±¡çš„å­˜åœ¨ï¼Œä½†è‡ªå·±ä¸æŒæœ‰å¯¹è±¡
[obj retain];
// è‡ªå·±æŒæœ‰å¯¹è±¡
```

é€šè¿‡ `retaion` æ–¹æ³•ï¼Œéè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ä¹Ÿå¯ä»¥æˆä¸ºè‡ªå·±æŒæœ‰ã€‚

#### ä¸å†éœ€è¦è‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶é‡Šæ”¾

#####  release

è‡ªå·±æŒæœ‰çš„å¯¹è±¡ï¼Œä¸€æ—¦ä¸å†éœ€è¦ï¼ŒæŒæœ‰è€…å¯ä»¥é€šè¿‡ `release` æ–¹æ³•ï¼Œé‡Šæ”¾è¯¥å¯¹è±¡ã€‚

```objc
// å–å¾—éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡
id obj = [NSMutableArray array];
// å–å¾—å¯¹è±¡çš„å­˜åœ¨ï¼Œä½†è‡ªå·±ä¸æŒæœ‰å¯¹è±¡
[obj retain];
// è‡ªå·±æŒæœ‰å¯¹è±¡
[obj release];
// é‡Šæ”¾å¯¹è±¡ï¼Œå¯¹è±¡ä¸å¯å†è¢«è®¿é—®
```

##### autorelease

è‡ªå®šä¹‰ä¸€ä¸ªç¬¦åˆå‰æ–‡å‘½åè§„èŒƒçš„ç”Ÿæˆå¯¹è±¡çš„æ–¹æ³•ï¼š

```objc
- (id)allocObject{
  //è‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡
  id obj = [[NSObject alloc] init];
  // è‡ªå·±æŒæœ‰å¯¹è±¡
  return objï¼›
}

// å–å¾—éè‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰çš„å¯¹è±¡
id obj1 = [obj0 allocObject];
// è‡ªå·±æŒæœ‰å¯¹è±¡
```

ç”±äºå†…éƒ¨æ˜¯é€šè¿‡ `alloc` æ–¹æ³•ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åœ¨ `retain` äº†ã€‚

> ç”±äºæ˜¯ç¬¦åˆä¸Šé¢çš„å‘½åè§„èŒƒï¼Œæ‰€ä»¥å† ARC ä¸­ï¼Œç³»ç»Ÿä¸ä¼šç»™ obj1 ä½¿ç”¨ retain æ–¹æ³•ã€‚
>
> æˆ‘æƒ³ åº”è¯¥æ˜¯é€šè¿‡ `alloc` æ–¹æ³•ï¼Œå¼•ç”¨è®¡æ•°å·²ç»åŠ è¿‡ä¸€äº†ï¼Œè€Œååˆæ²¡æœ‰ `release` è¿‡ï¼Œæœ€ç»ˆåªæœ‰ `obj1` ä¸€ä¸ªå˜é‡ä¼šæŒ‡å‘è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥å°±ä¸ç”¨å† `retain` äº†ã€‚

é‚£ä¹ˆå¦‚æœæ˜¯ç±»ä¼¼ ` [NSMutableArray array]` æ–¹å¼ï¼Œè¯¥å¦‚ä½•å–å¾—å¯¹è±¡å‘¢ï¼Ÿä»¥è‡ªå®šä¹‰ä¸€ä¸ª `object` æ–¹æ³•ä¸ºä¾‹ï¼š

```objc
- (id)object{
  id obj = [[NSObject alloc] init];
  // è‡ªå·±æŒæœ‰å¯¹è±¡
  [obj autorelease];
  // å–å¾—å¯¹è±¡çš„å­˜åœ¨ï¼Œä½†è‡ªå·±ä¸æŒæœ‰å¯¹è±¡
  return obj;
}

id obj1 = [obj0 object];
// å–å¾—å¯¹è±¡çš„å­˜åœ¨ï¼Œä½†è‡ªå·±ä¸æŒæœ‰
[obj1 retain]ï¼›
// è‡ªå·±æŒæœ‰å¯¹è±¡
```

> åœ¨ ARC ä¸­ï¼Œå¦‚æœä¸ç¬¦åˆä¸Šé¢çš„å‘½åè§„èŒƒï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ  autorelease æ–¹æ³•
>
> è¿™é‡Œç”±äº autorelease äº†ï¼Œæ‰€ä»¥å¼•ç”¨è®¡æ•°åˆä¸º0äº†ï¼Œå°±éœ€è¦åœ¨å¤–éƒ¨å† retain ä¸€æ¬¡äº†

ä¸Šä¾‹ä¸­ï¼Œä½¿ç”¨ `autorelease` æ–¹æ³•ï¼Œå–å¾—å¯¹è±¡çš„å­˜åœ¨ï¼Œä½†æ˜¯è‡ªå·±ä¸æŒæœ‰å¯¹è±¡ã€‚`autorelease` æä¾›è¿™æ ·çš„åŠŸèƒ½ï¼Œ**ä½¿å¯¹è±¡åœ¨è¶…å‡ºæŒ‡å®šçš„ç”Ÿå­˜èŒƒå›´èƒ½å¤Ÿè‡ªåŠ¨å¹¶æ­£ç¡®çš„é‡Šæ”¾**(è°ƒç”¨ release æ–¹æ³•)ã€‚

#### æ— æ³•é‡Šæ”¾éè‡ªå·±æŒæœ‰çš„å¯¹è±¡

é‡Šæ”¾éè‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶ä¼šå‘ç”Ÿå´©æºƒ



### alloc/retain/release/dealloc å®ç°

è‹¹æœå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿å­˜åœ¨æ•£åˆ—è¡¨ä¸­ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼š

1. å¯¹è±¡ç”¨å†…å­˜å—çš„åˆ†é…æ— é¡»è€ƒè™‘å†…å­˜å—å¤´éƒ¨
2. å¼•ç”¨è®¡æ•°è¡¨å„è®°å½•ä¸­å­˜æœ‰å†…å­˜å—åœ°å€ï¼Œå¯ä»å„ä¸ªè®°å½•è¿½æº¯åˆ°å„å¯¹è±¡çš„å†…å­˜å—ã€‚

å®ç°è§„åˆ™ï¼š

- è°ƒç”¨ `alloc` æˆ–è€… `reatain` åï¼Œå¼•ç”¨è®¡æ•°å€¼åŠ 1
- è°ƒç”¨ `release` åï¼Œå¼•ç”¨è®¡æ•°å‡1
- å¼•ç”¨è®¡æ•°å€¼ä¸º0åï¼Œè°ƒç”¨ `dealloc` æ–¹æ³•åºŸå¼ƒå¯¹è±¡

### autorelease

`autorelease` ä½¿å¯¹è±¡è¶…å‡ºä½œç”¨åŸŸåï¼Œå¯¹è±¡å®ä¾‹çš„ `release` å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨ã€‚å…¶å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

1. ç”Ÿæˆå¹¶æŒæœ‰ `NSAutoreleasePool` å¯¹è±¡
2. è°ƒç”¨å·²åˆ†é…å¯¹è±¡çš„ `autorelease` å®ä¾‹æ–¹æ³•
3. åºŸå¼ƒ `NSAutoreleasePool` å¯¹è±¡

å¯¹äºæ‰€æœ‰æ‰ç”¨è¿‡ `autorelease` å®ä¾‹æ–¹æ³•çš„å¯¹è±¡ï¼Œåœ¨åºŸå¼ƒ `NSAutoreleasePool` å¯¹è±¡æ—¶ï¼Œéƒ½å°†è°ƒç”¨ `release` å®ä¾‹æ–¹æ³•ã€‚

> `NSRunLoop` ä¼šè‡ªåŠ¨å®Œæˆ `NSAutoreleasePool` çš„ç”Ÿæˆã€æŒæœ‰å’ŒåºŸå¼ƒå¤„ç†ï¼Œä¸ä¸€å®šéè¦åº”ç”¨å¼€å‘è€…æ‰‹åŠ¨ä½¿ç”¨ `NSAutoreleasePool`ã€‚ä¸è¿‡å¦‚æœå­˜åœ¨å¤§é‡ `autorelease` çš„å¯¹è±¡çš„è¯ï¼Œè¿˜æ˜¯å»ºè®®è‡ªå·±ç”Ÿæˆå’ŒåºŸå¼ƒ `NSAutoreleasePool` çš„ã€‚

### autorelease å®ç°

`autorelease` å®ä¾‹æ–¹æ³•çš„æœ¬è´¨æ˜¯è°ƒç”¨ `NSAutoreleasePool` å¯¹è±¡çš„ `addObject` ç±»æ–¹æ³•ã€‚

å…¶å®å°±æ˜¯å°†è¦é‡Šæ”¾çš„å¯¹è±¡æ·»åŠ åˆ° `NSAutoreleasePool` ä¸­çš„æ•°ç»„ä¸­å»ã€‚å½“ `NSAutoreleasePool` å°†è¦é”€æ¯æ—¶ï¼Œå¯¹æ•°ç»„ä¸­çš„æ‰€æœ‰å¯¹è±¡è°ƒç”¨ `release` æ–¹æ³•ã€‚

## ARCè§„åˆ™

### æ‰€æœ‰æƒä¿®é¥°ç¬¦

ARC æœ‰æ•ˆæ—¶ï¼Œå¯¹è±¡ç±»å‹ä¸Šå¿…é¡»é™„åŠ æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼š

- __strong
- __weak
- __unsafe_unretained
- __autoreleasing

#### __strong ä¿®é¥°ç¬¦

__strong ä¿®é¥°ç¬¦æ˜¯é»˜è®¤çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢çš„ id å˜é‡ï¼Œå®é™…ä¸Šè¢«é™„åŠ äº†æ‰€æœ‰æƒä¿®é¥°ç¬¦

```objc
id obj = [[NSObject alloc] init];
=> id __strong obj = [[NSObject alloc] init];
```

å¦‚æœæŒ‡å®šäº†å˜é‡çš„ä½œç”¨äºï¼š

```objc
{
  id __strong obj = [[NSObject alloc] init];
}
// ç›¸å½“äºä¸‹é¢ğŸ‘‡
{
  id obj = [[NSObject alloc] init];
  [obj release];
}
```

`__strong` ä¿®é¥°ç¬¦**è¡¨ç¤ºå¯¹å¯¹è±¡çš„å¼ºå¼•ç”¨**ï¼ŒæŒæœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œåœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸæ—¶è¢«åºŸå¼ƒï¼Œéšç€å¼ºå¼•ç”¨çš„å¤±æ•ˆï¼Œå¼•ç”¨çš„å¯¹è±¡ä¼šéšä¹‹é‡Šæ”¾ã€‚

#### __weakä¿®é¥°ç¬¦

`__strong` ä¿®é¥°ç¬¦å®¹æ˜“å¼•èµ·å¼•ç”¨å¾ªç¯ï¼Œä½¿ç”¨ `__weak` ä¿®é¥°ç¬¦å¯ä»¥é¿å…å¾ªç¯å¼•ç”¨ã€‚

```objc
id __weak obj = [[NSObject alloc] init];
```

ä¸Šé¢çš„ä»£ç å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºä½¿ç”¨å¼±å¼•ç”¨ï¼Œæ–°å»º `NSObject` å¯¹è±¡åœ¨åˆ›å»ºåä¼šç«‹åˆ»é‡Šæ”¾(è¿™ä¹Ÿæ˜¯å¹³æ—¶ä½¿ç”¨ `weak` æ—¶éœ€è¦æ³¨æ„çš„)ã€‚éœ€è¦ä¿®æ”¹æˆä¸‹é¢

```objc
id __strong obj0 = [[NSObject alloc] init];
id __weak obj1 = obj0;
```

ä¸¾ä¸ªä¾‹å­ï¼š

```objc
id __weak obj1 = nil;
{
  id __strong obj0 = [[NSObject alloc] init];
  obj1 = obj0;
  NSLog(@"A: %@",obj1);
}
NSLog(@"B: %@",obj1);
```

ç”±äºå¼±å¼•ç”¨ï¼Œåœ¨æ‹¬å·åèŒƒå›´å¤–ï¼Œ`obj0` è¢«å›æ”¶ï¼Œ`obj1` ä¸ºç½®ä¸º `nil`

#### __unsafe_unretainedä¿®é¥°ç¬¦

å·²ç»è¢«åºŸå¼ƒçš„ä¿®é¥°ç¬¦ï¼Œè¿™ä¸ªä¿®é¥°ç¬¦å’Œ `__weak` çš„å·®åˆ«åœ¨äºï¼Œ`__weak` ä¿®é¥°ç¬¦åœ¨å¯¹è±¡è¢«å›æ”¶åä¼šç½®ä¸º `nil`ï¼Œè€Œè¯¥ä¿®é¥°ç¬¦åˆ™ä»æŒ‡å‘åŸæœ‰å†…å­˜åœ°å€ï¼Œè®¿é—®è¢«åºŸå¼ƒçš„å¯¹è±¡å°†å¯èƒ½ä¼šäº§ç”Ÿå´©æºƒã€‚

#### __autoreleasing ä¿®é¥°ç¬¦

> autorelease å…¶å®å°±æ˜¯å°† release æ–¹æ³•å»¶è¿Ÿä¸€æ®µæ—¶é—´æ‰§è¡Œ

ARC ä¸­æ— æ³•ç›´æ¥ä½¿ç”¨ `autorelease`ã€‚åœ¨ ARC æ— æ•ˆæ—¶ä¼šåƒä¸‹é¢æ¥ä½¿ç”¨ï¼š

```objc
// ARC æ— æ•ˆ
NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
id obj = [[NSObject alloc] init];
[obj autorelease];
[pool drain];
```

ACR æœ‰æ•ˆæ—¶ï¼Œå°†æºä»£ç å†™æˆè¿™æ ·:

```objc
@autoreleasepool{
  id __autoreleasing obj = [[NSObject alloc] init];
}
```

åœ¨ ARC æœ‰æ•ˆæ—¶ï¼Œç”¨ `@autoreleaseing` å—ä»£æ›¿ `NSAutoreleasePool`ç±»ï¼Œç”¨é™„æœ‰ `__autoreleasing` ä¿®é¥°ç¬¦çš„å˜é‡æ›¿ä»£ `autorelease` æ–¹æ³•ã€‚

## ARC çš„å®ç°

### __strongä¿®é¥°ç¬¦

```objc
{
  id __strong obj = [[NSObject alloc] init];
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿçš„ä»£ç  =>
{
  id obj = objc_msgSend(NSObject, @selector(alloc));
  objc_msgSend(obj, @selector(init));
  objc_release(obj);
}
```

ä¸¤æ¬¡è°ƒç”¨ `objc_msgSend` æ–¹æ³•ï¼Œå˜é‡ä½œç”¨åŸŸç»“æŸæ—¶é€šè¿‡ `objc_release` é‡Šæ”¾å¯¹è±¡ã€‚è™½ç„¶ ARC æœ‰æ•ˆæ—¶ä¸èƒ½ä½¿ç”¨ `release` æ–¹æ³•ï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ã€‚

å¦‚æœä½¿ç”¨å…¶ä»–çš„åˆ›å»ºæ–¹æ³•ï¼š

```objc
{
  id __strong obj = [NSMutableArray array];
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿçš„ä»£ç  =>
{
  id obj = objc_msgSend(NSMutableArray, @selector(array));
  objc_retainAutoreleasedReturnValue(obj);
  objc_release(obj);
}
```

ä¸­é—´è°ƒç”¨äº† `objc_retainAutoreleasedReturnValue()` æ–¹æ³•ã€‚å®ƒæŒæœ‰çš„å¯¹è±¡åº”ä¸º è¿”å›æ³¨å†Œåœ¨ `autoreleasepool` ä¸­å¯¹è±¡çš„æ–¹æ³•ï¼Œæˆ–æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ `objcautoreleaseReturnValue()` æ–¹æ³•æˆå¯¹å‡ºç°çš„ï¼Œç”¨äºä¼˜åŒ–ç¨‹åºè¿è¡Œã€‚æ¥çœ‹ `[NSMutableArray array]` æ–¹æ³•:

```objc
+ (id)array{
  return [[NSMutableArray alloc] init];
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿçš„ä»£ç  =>
+ (id)array{
  id obj = objc_msgSend(NSMutableArray, @selector(alloc));
  objc_msgSend(obj, @selector(init));
  return objc_autoreleaseReturnValue(obj);
}
```

è¿™æ ·åšå°±ä¸éœ€è¦å†æŠŠ `obj` å¯¹è±¡æ³¨å†Œåˆ° `NSAutoreleasePool` ä¸­äº†ï¼Œè€Œæ˜¯ç›´æ¥å¼ºå¼•ç”¨è¿™ä¸ªå¯¹è±¡ã€‚å¦‚ä¸‹å›¾ï¼š

![ä¼˜åŒ–](https://github.com/zhang759740844/MyImgs/blob/master/MyBlog/autoreleasepool1.png.jpeg?raw=true)

### __weak

å‡è®¾å˜é‡ `obj` é™„åŠ  `__strong` ä¿®é¥°ç¬¦ä¸”å¯¹è±¡è¢«èµ‹å€¼:

```objc
{
  id __weak obj1 = obj;
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç  =>
{
  id obj1;
  objc_initWeak(&obj1,obj);
  objc_destroyWeak(&obj1);
}
```

å…¶ä¸­ `objc_initWeak` å‡½æ•°ï¼Œä¼šå°†é™„æœ‰ `__weak` ä¿®é¥°ç¬¦çš„å˜é‡åˆå§‹åŒ–ä¸º0åï¼Œè°ƒç”¨ `objc_storeWeak` å‡½æ•°ã€‚`objc_destroyWeak` å‡½æ•°ä¼šå°†0ä½œä¸ºå‚æ•°è°ƒç”¨ `objc_storeWeak` å‡½æ•°ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ç­‰æ•ˆäºä¸‹é¢ï¼š

```objc
ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç  =>
{
  id obj1;
  obj1 = 0;
  objc_storeWeak(&obj1, obj);
  objc_storeWeak(&obj1, 0);
}
```

`objc_storeWeak` å‡½æ•°æŠŠç¬¬äºŒå‚æ•°çš„èµ‹å€¼å¯¹è±¡çš„åœ°å€ä½œä¸ºé”®å€¼ï¼Œå°†ç¬¬ä¸€å‚æ•°çš„é™„æœ‰`__weak` ä¿®é¥°ç¬¦çš„å˜é‡çš„åœ°å€æ³¨å†Œåˆ° weak è¡¨ä¸­ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸º0ï¼Œåˆ™æŠŠå˜é‡çš„åœ°å€ä» weak è¡¨ä¸­åˆ é™¤ã€‚

weak è¡¨å’Œå¼•ç”¨è®¡æ•°å™¨è¡¨ç›¸åŒï¼Œä½œä¸ºæ•£åˆ—è¡¨è¢«å®ç°ã€‚å¦‚æœä½¿ç”¨ weak è¡¨ï¼Œå°†åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä½œä¸ºé”®å€¼è¿›è¡Œæ£€ç´¢ï¼Œå°±èƒ½é«˜é€Ÿåœ°è·å–å¯¹åº”çš„é™„æœ‰ `__weak` ä¿®é¥°ç¬¦çš„å˜é‡çš„åœ°å€ã€‚

å‡è®¾è€ƒè™‘åˆ° `obj1` æ˜¯è¢«åŠ å…¥åˆ° `autoreleasepool` ä¸­çš„ã€‚é‚£ä¹ˆç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

```objc
{
  id __weak obj1 = obj;
  NSLog(@"%@",obj1);
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç  =>
{
  id obj1;
  objc_initWeak(&obj1,obj);
  id tmp = objc_loadWeakRetained(&obj1);
  objc_autorelease(tmp);
  NSLog(@"%@",tmp);
  objc_destroyWeak(&obj1);
}
```

ä¸è¢«èµ‹å€¼ç›¸æ¯”ï¼Œå¢åŠ äº†`objc_loadWeakRetained` å’Œ `objc_autorelease` æ–¹æ³•çš„è°ƒç”¨ï¼š

1. `objc_loadWeakRetained` å–å‡ºäº†é™„æœ‰ `__weak` ä¿®é¥°ç¬¦å˜é‡æ‰€å¼•ç”¨çš„å¯¹è±¡å¹¶ `retain`
2. `objc_autorelease` å°†å¯¹è±¡æ³¨å†Œåˆ° `autoreleasepool` ä¸­

> ä¹Ÿå°±æ˜¯è¯´åœ¨ä½¿ç”¨ weak å˜é‡çš„ä»£ç å—é‡Œï¼Œä¸´æ—¶çš„äº§ç”Ÿäº†å¼ºå¼•ç”¨

å¦‚æœå¤§é‡åœ°ä½¿ç”¨é™„æœ‰ `__weak` ä¿®é¥°ç¬¦çš„å˜é‡ï¼Œæ³¨å†Œåˆ° `autoreleasepool` çš„å¯¹è±¡ä¼šå¤§é‡åœ°å¢åŠ ï¼Œå³ä¼šå¤§é‡åˆ›å»º `tmp`ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨é™„æœ‰ `__weak` ä¿®é¥°ç¬¦çš„å˜é‡ï¼Œæœ€å¥½å…ˆæš‚æ—¶ç»™é™„æœ‰ `__strong` ä¿®é¥°ç¬¦çš„å˜é‡åå†ä½¿ç”¨ï¼š

```objc
{
  id __weak o = obj;
  id tmp = o;
  NSLog(@"1 %@",obj1);
  NSLog(@"2 %@",obj1);
  NSLog(@"3 %@",obj1);
}
```

å¦‚æœæ²¡æœ‰ `id tmp = o`ï¼Œ`o` å°±ä¼šè¢«æ³¨å†Œåˆ° `autoreleasepool` æ³¨å†Œ3æ¬¡ï¼Œä½†æ˜¯å¦‚æœæœ‰è¿™å¥ï¼Œå°±åªä¼šæ³¨å†Œä¸€æ¬¡ã€‚

### __autoreleasing

`__autoreleasing` ä¿®é¥°ç¬¦çš„å˜é‡ç­‰åŒäº ARC æ— æ•ˆæ—¶è°ƒç”¨å¯¹è±¡çš„ autorelease æ–¹æ³•ï¼š

```objc
@autoreleasepool{
  id __autoreleasing obj = [[NSObject alloc] init];
}
ç¼–è¯‘å™¨æ¨¡æ‹Ÿç¼–ç  =>
{
  id pool = objc_autoreleasePoolPush();
  id obj = objc_msgSend(NSObject, @selector(alloc));
  objc_msgSend(obj,@selector(init));
  objc_autorelease(obj);
  objc_autoreleasePoolPop(pool);
}
```

å’Œè‹¹æœ `autorelease` å®ç°ä¸­çš„è¯´æ˜å®Œå…¨ç›¸åŒã€‚



# Blocks

## Blocks æ¨¡å¼

### Block è¯­æ³•

Blockçš„æ ¼å¼:

> ^ è¿”å›å€¼ç±»å‹ ï¼ˆå‚æ•°åˆ—è¡¨ï¼‰ {è¡¨è¾¾å¼}

å…¶ä¸­ï¼Œè¿”å›å€¼ç±»å‹å’Œå‚æ•°åˆ—è¡¨å¯ä»¥çœç•¥ã€‚

###  Block ç±»å‹å˜é‡

å…ˆæ¥çœ‹ä¸€ä¸‹ Cè¯­è¨€çš„å‡½æ•°æŒ‡é’ˆï¼š

```c
int (*funcptr)(int)
```

å£°æ˜ Block ç±»å‹å˜é‡å’Œ Cè¯­è¨€å‡ ä¹ä¸€è‡´ï¼Œé™¤äº†å°† `*` æ”¹ä¸º `^`ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```objc
int (^blk)(int)
```

Block å¯ä»¥ä½œä¸ºå³å€¼ï¼Œè¿”å›ç±»å‹ï¼Œå‚æ•°ç±»å‹ã€‚å¯ä»¥ä½¿ç”¨ `typedef` å®šä¹‰ï¼š

```objc
typedef int (^blk_t)(int);
=>
blk_t blk;
```

è¿™æ ·ï¼Œ`blk_t` å°±**ä»å˜é‡åï¼Œå˜æˆäº†å˜é‡ç±»å‹**ã€‚

### æˆªè·è‡ªåŠ¨å˜é‡å€¼

Block è¡¨è¾¾å¼æˆªè·æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡çš„å€¼ï¼Œå³ä¿å­˜è¯¥è‡ªåŠ¨å˜é‡çš„ç¬é—´å€¼ã€‚å› ä¸º Block è¡¨è¾¾å¼ä¿å­˜äº†è‡ªåŠ¨å˜é‡çš„å€¼ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œ Block è¯­æ³•åï¼Œå³ä½¿æ”¹å†™ Block ä¸­ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡çš„å€¼ä¹Ÿä¸ä¼šå½±å“ Block æ‰§è¡Œæ—¶è‡ªåŠ¨å˜é‡çš„å€¼ã€‚è¿™å°±æ˜¯è‡ªåŠ¨å˜é‡å€¼çš„æˆªè·ã€‚

### __blockè¯´æ˜ç¬¦

è‡ªåŠ¨å˜é‡å€¼æˆªè·åªèƒ½ä¿å­˜æ‰§è¡Œ Block è¯­æ³•ç¬é—´çš„å€¼ã€‚ä¿å­˜åå°±ä¸èƒ½æ”¹å†™è¯¥å€¼ã€‚å¦‚æœå°è¯•æ”¹å†™æˆªè·çš„è‡ªåŠ¨å˜é‡å€¼ï¼Œä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯ã€‚

è‹¥æƒ³åœ¨ Block è¯­æ³•çš„è¡¨è¾¾å¼ä¸­å°†å€¼èµ‹ç»™åœ¨ Block è¯­æ³•å¤–å£°æ˜çš„è‡ªåŠ¨å˜é‡ï¼Œéœ€è¦åœ¨è¯¥è‡ªåŠ¨å˜é‡ä¸Šé™„åŠ  `__block` è¯´æ˜ç¬¦ã€‚

å¯¹äºæˆªè·çš„ OC å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å¯¹è±¡çš„å†…å®¹ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹å¯¹è±¡çš„åœ°å€æŒ‡å‘ï¼Œå¦åˆ™è¿˜æ˜¯éœ€è¦ä½¿ç”¨ `__block`ã€‚

## Blocks çš„å®ç°

### Blockçš„å®è´¨

clang(LLVM ç¼–è¯‘å™¨)é€šè¿‡ â€œ-rewrite-objcâ€ é€‰é¡¹å¯ä»¥å°†å«æœ‰ Block è¯­æ³•çš„æºä»£ç å˜æ¢ä¸º Cè¯­è¨€æºä»£ç ï¼š

```objc
clang -rewrite-objc æºä»£ç æ–‡ä»¶å
```

æ¯”å¦‚ä¸€ä¸ªæœ€ç®€å•çš„ Block ï¼š

```objc
int main(){
  void (^blk)(void) = ^{printf("Block\n");};
  blk();
  return 0;
}
```

å…¶ä¸­ï¼Œ`^{printf("Block\n"};` å¯ä»¥è½¬åŒ–ä¸ºï¼š

```objc
static void __main_block_func_0(struct __main_block_impl_0 *__cself){
  printf("Block\n");
}
```

é€šè¿‡ Blocks ä½¿ç”¨çš„åŒ¿åå‡½æ•°å®é™…ä¸Šè¢«ä½œä¸ºç®€å•çš„ Cè¯­è¨€å‡½æ•°æ¥å¤„ç†ã€‚å¦å¤–ï¼Œæ ¹æ® Block è¯­æ³•æ‰€å±çš„å‡½æ•°åå’Œè¯¥ Block è¯­æ³•åœ¨è¯¥å‡½æ•°å‡ºç°çš„é¡ºåºå€¼(æ­¤å¤„ä¸º0)æ¥ç»™ç» clang å˜æ¢çš„å‡½æ•°å‘½åã€‚

è¯¥å‡½æ•°çš„å‚æ•° `__cself` ç›¸å½“äº OC ä¸­çš„ `self`ï¼Œæ˜¯ `__main_block_impl_0` ç»“æ„ä½“çš„æŒ‡é’ˆï¼š

```objc
struct __main_block_impl_0{
  struct __block_impl impl;
  struct __main_block_desc_0 *Desc;
}
//å…¶ä¸­ï¼š
struct __block_impl{
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
}  
struct __main_block_desc_0{
  unsigned long reserved;
  unsigned long Block_size;
}
```

æ¥çœ‹ä¸€ä¸‹è¯¥å®ä¾‹çš„æ„é€ æ–¹æ³•ï¼š

```objc
__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flag=0){
  impl.isa = &_NSConcreteStackBlock;
  impl.Flags = flags;
  impl.FuncPtr = fp;
  Desc =desc;
}
```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”± Block è¯­æ³•è½¬æ¢çš„ C è¯­è¨€å‡½æ•°æŒ‡é’ˆï¼Œæœ¬ä¾‹ä¸­å°†ä¼šä¼ å…¥ä¸Šé¢çš„ `__main_block_func_0`ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä½œä¸ºé™æ€å…¨å±€å˜é‡åˆå§‹åŒ–çš„ `__main_block_desc_0` ç»“æ„ä½“å®ä¾‹æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆå†…ä¿å­˜äº† `__main_block_impl_0` ç»“æ„ä½“å®ä¾‹çš„å¤§å°ã€‚

è§‚å¯Ÿä¸Šé¢çš„æ„é€ æ–¹æ³• `impl.isa = &_NSConcreteStackBlock;` ï¼Œå…¶ `isa` æŒ‡é’ˆæŒ‡å‘äº† `&NSConcreteStackBlock`ï¼Œè¯´æ˜ **Block çš„å®è´¨æ˜¯ Objective-C çš„å¯¹è±¡**ã€‚

é€šè¿‡ä¸Šé¢çš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ `void (^blk)(void) = ^{printf("Block\n");};` çš„è½¬æ¢åçš„ä»£ç ï¼š

```objc
struct __main_block_impl_0 tmp = (void (*)(void))&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA);
void (*blk)(void) = &tmp;
```

è¯¥æºç å°† **æ ˆä¸Šï¼ˆå› ä¸ºè¿™é‡Œçš„æ‰€æœ‰ç»“æ„ä½“å¹¶æ²¡æœ‰ malloc å†…å­˜ï¼Œæ‰€ä»¥éƒ½æ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ï¼‰**ç”Ÿæˆçš„ `__main_block_impl_0` ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆï¼Œèµ‹å€¼ç»™ `__main_block_impl_0` ç»“æ„ä½“æŒ‡é’ˆç±»å‹çš„å˜é‡ `blk`ã€‚

ç»§ç»­æŸ¥çœ‹ `blk()` çš„è½¬æ¢åçš„ä»£ç ï¼š

```objc
((void (*)(struct __block_impl *))(struct __block_impl *)blk)->FuncPtr)((struct __block_impl *)blk);
ç®€åŒ–å =>
(*blk->impl.FuncPtr)(blk);
```

å°±æ˜¯è°ƒç”¨äº† `blk` ä¸­ä¿å­˜çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶å°† `blk` ä½œä¸º `__cself` ä¼ å…¥ã€‚

### æˆªè·è‡ªåŠ¨å˜é‡å€¼

å‰é¢çš„ Block ä¸­æ²¡æœ‰ç”¨åˆ°ä»»ä½•è‡ªåŠ¨å˜é‡ï¼Œæ‰€ä»¥`__main_block_impl_0` ä¸­åªæœ‰ä¸¤ä¸ªæˆå‘˜ï¼š`__block_impl` å’Œ `__main_block_desc_0`ã€‚å¦‚æœ Block ä¸­ç”¨åˆ°äº†è‡ªåŠ¨å˜é‡ï¼Œå°†ä¼šæ·»åŠ ç›¸åº”å‚æ•°ï¼Œå¦‚åœ¨ Block ä¸­ç”¨åˆ°äº† `char *fmt` å’Œ `int val` ï¼Œé‚£ä¹ˆç»“æ„ä½“ï¼Œæ„é€ å‡½æ•°ç­‰éƒ½è¦ç›¸åº”æ·»åŠ ï¼š

```objc
struct __main_block_impl_0{
  struct __block_impl impl;
  struct __main_block_desc_0 *Desc;
  const char *fmt;
  int val;
}
```

æ‰€è°“â€œæˆªè·è‡ªåŠ¨å˜é‡å€¼â€ï¼Œæ„å‘³ç€åœ¨æ‰§è¡Œ Block è¯­æ³•æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡å€¼è¢«ä¿å­˜åˆ° Block çš„ç»“æ„ä½“å®ä¾‹ï¼ˆå³ Block è‡ªèº«ï¼‰ä¸­

### __block è¯´æ˜ç¬¦

ä¸Šé¢è¯´åˆ° Block ä¼šæˆªå–è‡ªåŠ¨å˜é‡å€¼ï¼Œå¹¶ä¸” Block å†…éƒ¨ä¸èƒ½ä¿®æ”¹è‡ªåŠ¨å˜é‡å€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœæƒ³è¦åœ¨ Block ä¸­ä¿®æ”¹å¤–éƒ¨å˜é‡çš„å€¼ï¼Œéœ€è¦åœ¨å˜é‡ä¸Šæ·»åŠ  `__block` è¯´æ˜ç¬¦ï¼ŒåŠ ä¸Šè¿™ä¸ªè¯´æ˜ç¬¦åï¼Œè¿™å°±ä¸å†æ˜¯ä¸ªç®€å•çš„å˜é‡äº†ï¼Œå®ƒä¸ºè‡ªèº«åˆ›å»ºäº†ä¸€ä¸ªç»“æ„ä½“ã€‚æ¯”å¦‚ä¸€ä¸ª `int` ç±»å‹çš„å˜é‡ `val`,å®ƒå˜æˆäº†ä¸€ä¸ªç»“æ„ä½“å®ä¾‹ `__Block_byref_val_0`:

```objc
struct __Block_byref_val_0{
  void *__isa;
  __Block_byref_val_0 *__forwarding;
  int __flags;
  int __size;
  int val;
};
```

å…¶ä¸­ `__forwarding` æŒæœ‰æŒ‡å‘è‡ªèº«çš„æŒ‡é’ˆï¼Œ`val` ä¿å­˜äº† `int` çš„å€¼ã€‚

```objc
__block int val = 10;
è½¬æ¢å=>
__Block_byref_val_0 val = {
  0,
  &val,
  0,
  sizeof(__Block_byref_val_0),
  10
};
```

æ¯”å¦‚ä¸€ä¸ªç»™ `__block` å˜é‡èµ‹å€¼çš„ä»£ç å°†ä¼šè½¬æ¢æˆä¸‹é¢ï¼š

```objc
^(val = 1;)
=>
static void __main_block_func_0(struct __main_block_impl_0 *__cself){
  __Block_byref_val_0 *val = __cself->val;
  (val->__forwarding->val) = 1;
}
```

### Block å­˜å‚¨åŸŸ

Block è½¬æ¢ä¸º Block ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œ`__block` å˜é‡è½¬æ¢ä¸º `__block` å˜é‡çš„ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ã€‚**æ‰€è°“ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„è¯¥ç»“æ„ä½“çš„å®ä¾‹ã€‚**

Block ä¹Ÿæ˜¯ OC å¯¹è±¡ã€‚å°† Block å½“åš OC å¯¹è±¡æ¥çœ‹æ—¶ï¼Œè¯¥ Block ç±»ä¸º `_NSConcreteStackBlock`ï¼Œç±»ä¼¼çš„è¿˜æœ‰ï¼š

- _NSConcreteStackBlock
- _NSConcreteGlobalBlock 
- _NSConcreteMallocBlock

è®¾ç½®åœ¨æ ˆä¸Šçš„ Blockï¼Œå¦‚æœå…¶æ‰€å±çš„å˜é‡ä½œç”¨åŸŸç»“æŸï¼Œè¯¥ Block å°±è¢«åºŸå¼ƒäº†ã€‚ç”±äº `__block` å˜é‡ä¹Ÿé…ç½®åœ¨æ ˆä¸Šï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå…¶æ‰€å±çš„å˜é‡ä½œç”¨åŸŸç»“æŸï¼Œåˆ™è¯¥ `__block` å˜é‡ä¹Ÿä¼šè¢«åºŸå¼ƒã€‚Blocks æä¾›äº†å°† Block å’Œ `__block` ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¤åˆ¶åˆ°å †ä¸Šçš„ Block å°† `_NSConcreteMallocBlock` ç±»å¯¹è±¡å†™å…¥ Block çš„ç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡ isaï¼š

```objc
impl.isa = &_NSConcreteMallocBlock;
```

é€šè¿‡ `copy` æ–¹æ³•ï¼Œå°† Block ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šï¼š

```objc
[^{NSLog(@"haha")} copy];
```

### __block å˜é‡å­˜å‚¨åŸŸ

å‰é¢è¯´åˆ° `__block` äº§ç”Ÿçš„ç»“æ„ä½“ `__Block_byref_val_0` ä¸­ä¼šæœ‰ä¸€ä¸ª `forwarding` çš„æŒ‡é’ˆï¼Œä¸€èˆ¬æŒ‡å‘è‡ªå·±ã€‚é‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

å¯¹äºä¸€ä¸ª `__block` å’Œ Block å˜é‡ï¼ŒåŸæœ¬æ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ã€‚å½“ Block è¢«å¤åˆ¶åˆ°å †ä¸Šåï¼Œå…¶ä¸­ä½¿ç”¨åˆ°çš„ `__block` å˜é‡ä¹Ÿä¼šä»æ ˆä¸­å¤åˆ¶åˆ°å †ä¸Šï¼Œå¹¶è¢« Block æŒæœ‰ã€‚å¦‚ä¸‹å›¾ï¼š

![å¤åˆ¶](https://github.com/zhang759740844/MyImgs/blob/master/MyBlog/MallocBlock.JPG?raw=true)

ç°åœ¨ï¼Œéœ€è¦åœ¨ Block å†…å¤–ä¿®æ”¹ `__block` çš„å€¼ï¼Œå³ `^{++val;}` å’Œ `++val;` éƒ½èƒ½å¤Ÿä¿®æ”¹å€¼ï¼Œè¿™å°±ä½“ç°äº† `forwarding` è¿™ä¸ªæŒ‡é’ˆçš„ç›®çš„äº†ï¼š



![å¤åˆ¶](https://github.com/zhang759740844/MyImgs/blob/master/MyBlog/forwardingBlock.jpg?raw=true)

åœ¨å˜æ¢ Block è¯­æ³•çš„å‡½æ•°ä¸­ï¼Œè¯¥å˜é‡ val ä¸ºå¤åˆ¶åˆ°å †ä¸Šçš„ `__block` å˜é‡ç”¨ç»“æ„ä½“å®ä¾‹ï¼Œè€Œä½¿ç”¨çš„ä¸ Block æ— å…³çš„å˜é‡ valï¼Œä¸ºå¤åˆ¶å‰æ ˆä¸Šçš„ `__block` å˜é‡ç”¨ç»“æ„ä½“å®ä¾‹ã€‚

æ ˆä¸Šçš„ `__block` å˜é‡ç”¨ç»“æ„ä½“å®ä¾‹åœ¨ `__block` å˜é‡ä»æ ˆå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œä¼šå°†æˆå‘˜å˜é‡ `__forwarding` çš„å€¼æ›¿æ¢ä¸ºå¤åˆ¶ç›®æ ‡å †ä¸Šçš„ `__block` å˜é‡ç”¨ç»“æ„ä½“å®ä¾‹çš„åœ°å€ã€‚é€šè¿‡è¯¥åŠŸèƒ½ï¼Œæ— è®ºåœ¨ Block è¯­æ³•ä¸­ã€Block è¯­æ³•å¤–ä½¿ç”¨ `__block` å˜é‡ï¼Œè¿˜æ˜¯ `__block` å˜é‡é…ç½®åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šï¼Œéƒ½å¯ä»¥é¡ºåˆ©åœ°è®¿é—®åŒä¸€ä¸ª `__block` å˜é‡ã€‚

### æˆªè·å¯¹è±¡

æ¯”è¾ƒä¸‹é¢ä¸¤æ®µä»£ç ä¸­ï¼Œ Block å—ä¸­çš„æ‰“å°æ—¥å¿—ï¼š

```objc
// ä»£ç æ®µä¸€
blk_t blk;
{
  id array = [[NSMutableArray alloc] init];
  blk = [^(id obj){
    [array addObject:obj];
    NSLog(@"array count = %ld",[array count]);
  } copy];
}
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);

// ä»£ç æ®µäºŒ
blk_t blk;
{
  id array = [[NSMutableArray alloc] init];
  blk = ^(id obj){
    [array addObject:obj];
    NSLog(@"array count = %ld",[array count]);
  };
}
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
```

è¾“å‡ºï¼š

```objc
// ä»£ç æ®µä¸€
array count = 1
array count = 1
array count = 1
  
// ä»£ç æ®µäºŒ
å¼ºåˆ¶ç»“æŸ
```

å› ä¸ºä¸‹é¢çš„ä»£ç æ²¡æœ‰ copy åˆ°å †ä¸Šï¼Œæ‰€ä»¥ array ä¹Ÿå°±ä»ç„¶å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå³ä½¿ Block æˆªè·äº†å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šéšç€å˜é‡ä½œç”¨åŸŸçš„ç»“æŸè€Œè¢«åºŸå¼ƒã€‚

æ‰€ä»¥é™¤äº†ä¸‹é¢çš„æƒ…å†µï¼Œæ¨èè°ƒç”¨ Block çš„ copy æ–¹æ³•ï¼š

- Block ä½œä¸ºå‡½æ•°è¿”å›å€¼è¿”å›æ—¶
- å°† Block èµ‹å€¼ç»™ç±»çš„é™„æœ‰ `__strong` ä¿®é¥°ç¬¦çš„ `id` ç±»å‹æˆ– Block ç±»å‹æˆå‘˜å˜é‡æ—¶
- å‘æ–¹æ³•å‘½ä¸­å«æœ‰ `usingBlock` çš„ Cocoa æ¡†æ¶æ–¹æ³•æˆ– GCD çš„ API ä¸­ä¼ é€’ Block æ—¶

### __block å˜é‡å’Œå¯¹è±¡

ä¸Šé¢çš„ä¾‹å­å¦‚æœæ”¹æˆä¸‹é¢å°†ä¼šè¾“å‡ºä»€ä¹ˆç»“æœå‘¢ï¼š

```objc
// ä»£ç æ®µä¸€
blk_t blk;
{
  id array = [[NSMutableArray alloc] init];
  id __weak array2 = array;
  blk = [^(id obj){
    [array2 addObject:obj];
    NSLog(@"array2 count = %ld",[array2 count]);
  } copy];
}
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);

// ä»£ç æ®µäºŒ
blk_t blk;
{
  id array = [[NSMutableArray alloc] init];
  __block id __weak array2 = array;
  blk = [^(id obj){
    [array2 addObject:obj];
    NSLog(@"array2 count = %ld",[array2 count]);
  } copy];
}
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
blk([[NSObject alloc] init]);
```

è¾“å‡ºï¼š

```objc
// ä»£ç æ®µä¸€
array2 count = 0
array2 count = 0
array2 count = 0
// ä»£ç æ®µäºŒ
array2 count = 0
array2 count = 0
array2 count = 0
```

è™½ç„¶éƒ½ç”¨äº† copy æ–¹æ³•ï¼Œä½†æ˜¯ä»£ç æ®µä¸€ç”±äºå¼±å¼•ç”¨äº† `array`ï¼Œå¯¼è‡´ `array` åœ¨ä½œç”¨åŸŸå¤–è¢«å›æ”¶ï¼Œ`array2` è¢«ç½®ä¸º `nil`ã€‚åŒæ ·çš„ï¼Œå³ä½¿å¢åŠ äº† `__block` ä¿®é¥°ç¬¦ï¼Œä¹Ÿåªæ˜¯æ”¹å˜ `array2` çš„ç»“æ„ï¼Œå¼•ç”¨è®¡æ•°è¯¥å›æ”¶çš„æ—¶å€™è¿˜æ˜¯å›æ”¶äº†ï¼Œæ‰€ä»¥å¯¹ç»“æœæ²¡æœ‰ä»»ä½•å½±å“ã€‚

### Block å¾ªç¯å¼•ç”¨

Block æœ‰å¯èƒ½ä¼šå¼•èµ·å¾ªç¯å¼•ç”¨æ˜¯è¢«ç†ŸçŸ¥çš„äº†ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨ `__weak` è¯´æ˜ç¬¦çš„æ–¹å¼æ‰“ç ´å¼•ç”¨å¾ªç¯ï¼Œå¦‚ï¼š

```objc
- (id)init{
  self = [super init];
  id __weak tmp = self;
  blk = ^{NSLog(@"self = %@", tmp);};
  return self;
}
```

é™¤äº†ä½¿ç”¨ `__weak` è¿˜å¯ä»¥ä½¿ç”¨ `__block`ï¼Œåœ¨ Block å†…ä½¿ç”¨å®Œåï¼Œæ‰‹åŠ¨å°†å˜é‡ç½®ä¸º `nil`:

```objc
- (id)init{
  self = [super init];
  __block id tmp = self;
  blk = ^{
    NSLog(@"self = %@", tmp);
    tmp = nil;
  };
  return self;
}
```

ä½¿ç”¨ä¸Šé¢æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ‰‹åŠ¨æ§åˆ¶å¯¹è±¡çš„æŒæœ‰æ—¶é—´ï¼Œè€Œç¼ºç‚¹æ˜¯å¿…é¡»è¦æ‰§è¡Œ Blockï¼Œå¦åˆ™ä¼šäº§ç”Ÿå¼•ç”¨å¾ªç¯ã€‚

# GCD

API çš„ä½¿ç”¨åœ¨æˆ‘å¦å¤–ä¸€ç¯‡ GCD çš„æ€»ç»“ä¸­æœ‰è¯¦ç»†çš„è®°è¿°[GCDé˜Ÿåˆ—](https://zhang759740844.github.io/2016/08/02/GCDé˜Ÿåˆ—/)ï¼Œä¸è¯¦ç»†æè¿°äº†ã€‚





























 